generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================== BENUTZER & ROLLEN ====================

model User {
  id            String   @id @default(cuid())
  discordId     String   @unique
  username      String
  displayName   String?
  avatar        String?
  email         String?
  roleId        String?
  role          Role?    @relation(fields: [roleId], references: [id])
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationen
  employee             Employee?
  auditLogs            AuditLog[]
  tasks                Task[]
  issuedSanctions      Sanction[]
  treasuryTransactions TreasuryTransaction[]
  notes                Note[]
  announcements        Announcement[]
  storedEvidence       Evidence[] @relation("EvidenceStoredBy")
  releasedEvidence     Evidence[] @relation("EvidenceReleasedBy")
  submittedTuning      TuningInvoice[] @relation("TuningSubmittedBy")
  completedTuning      TuningInvoice[] @relation("TuningCompletedBy")

  @@map("users")
}

model Role {
  id            String   @id @default(cuid())
  name          String   @unique
  displayName   String
  color         String   @default("#6B7280")
  discordRoleId String?
  level         Int      @default(0)
  permissions   Permission[]
  users         User[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  category    String
  roles       Role[]
  createdAt   DateTime @default(now())

  @@map("permissions")
}

// ==================== PERSONAL ====================

model Employee {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeNumber   String?  @unique
  rank          String   @default("Cadet")
  rankLevel     Int      @default(0) // 1-17 aus Discord Rollen
  department    String   @default("Patrol")
  status        String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED, ON_LEAVE, TERMINATED
  hireDate      DateTime @default(now())
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationen
  absences      Absence[]
  assignedTasks Task[]     @relation("TaskAssignee")
  sanctions     Sanction[]

  @@map("employees")
}

// ==================== ABMELDUNGEN ====================

model Absence {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type        String   // "ABSENCE" = Abmeldung, "DAY_OFF" = Dienstfrei
  reason      String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([employeeId])
  @@index([startDate, endDate])
  @@map("absences")
}

// ==================== SYSTEM ====================

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  userAgent String?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Backup {
  id        String   @id @default(cuid())
  filename  String
  size      Int
  path      String
  status    String   @default("COMPLETED")
  createdAt DateTime @default(now())

  @@map("backups")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ==================== LEADERSHIP ====================

// Aufgaben (Trello-ähnlich)
model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("OPEN") // OPEN, IN_PROGRESS, DONE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  assigneeId  String?
  assignee    Employee? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  dueDate     DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([assigneeId])
  @@index([createdById])
  @@index([status])
  @@map("tasks")
}

// Sanktionen
model Sanction {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  hasWarning  Boolean   @default(false) // Verwarnung
  hasFine     Boolean   @default(false) // Geldstrafe
  hasMeasure  Boolean   @default(false) // Maßnahme
  reason      String
  amount      Int?      // Für Geldstrafen (in Dollar)
  measure     String?   // Beschreibung der Maßnahme
  issuedById  String
  issuedBy    User      @relation(fields: [issuedById], references: [id])
  status      String    @default("ACTIVE") // ACTIVE, REVOKED, EXPIRED
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([employeeId])
  @@index([issuedById])
  @@map("sanctions")
}

// Kasse
model Treasury {
  id           String   @id @default(cuid())
  regularCash  Int      @default(0) // Normale Kasse in Dollar
  blackMoney   Int      @default(0) // Schwarzgeld in Dollar
  updatedAt    DateTime @updatedAt

  @@map("treasury")
}

model TreasuryTransaction {
  id          String   @id @default(cuid())
  type        String   // DEPOSIT, WITHDRAWAL
  moneyType   String   // REGULAR, BLACK
  amount      Int      // Betrag in Dollar
  reason      String
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([createdById])
  @@index([moneyType])
  @@map("treasury_transactions")
}

// Notizen
model Note {
  id          String   @id @default(cuid())
  title       String
  content     String
  category    String   @default("GENERAL") // GENERAL, MEETING, IMPORTANT
  isPinned    Boolean  @default(false)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
  @@index([category])
  @@map("notes")
}

// Discord Ankündigungen
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String
  channelId   String?
  messageId   String?   // Discord Message ID nach dem Senden
  status      String    @default("DRAFT") // DRAFT, SENT
  sentAt      DateTime?
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([createdById])
  @@index([status])
  @@map("announcements")
}

// ==================== ASSERVATE ====================

model Evidence {
  id          String    @id @default(cuid())
  name        String
  description String?
  category    String    @default("SONSTIGES") // WAFFEN, DROGEN, GELD, FAHRZEUGE, DOKUMENTE, SONSTIGES
  quantity    Int       @default(1)
  location    String?   // Lagerort
  caseNumber  String?   // Aktenzeichen
  status      String    @default("EINGELAGERT") // EINGELAGERT, AUSGELAGERT, VERNICHTET, FREIGEGEBEN
  storedById  String
  storedBy    User      @relation("EvidenceStoredBy", fields: [storedById], references: [id])
  releasedById String?
  releasedBy  User?     @relation("EvidenceReleasedBy", fields: [releasedById], references: [id])
  releasedAt  DateTime?
  releaseReason String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([category])
  @@index([caseNumber])
  @@map("evidence")
}

// ==================== TUNING RECHNUNGEN ====================

model TuningInvoice {
  id          String    @id @default(cuid())
  amount      Int                           // Betrag in Dollar
  imagePath   String                        // Pfad zum Beweisfoto
  status      String    @default("OFFEN")   // OFFEN, ERLEDIGT
  submittedById String
  submittedBy User      @relation("TuningSubmittedBy", fields: [submittedById], references: [id])
  completedById String?
  completedBy User?     @relation("TuningCompletedBy", fields: [completedById], references: [id])
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([submittedById])
  @@map("tuning_invoices")
}
