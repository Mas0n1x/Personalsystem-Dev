generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================== BENUTZER & ROLLEN ====================

model User {
  id            String   @id @default(cuid())
  discordId     String   @unique
  username      String
  displayName   String?
  avatar        String?
  email         String?
  roleId        String?
  role          Role?    @relation(fields: [roleId], references: [id])
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationen
  employee             Employee?
  auditLogs            AuditLog[]
  tasks                Task[]
  issuedSanctions      Sanction[]
  treasuryTransactions TreasuryTransaction[]
  notes                Note[]
  announcements        Announcement[]
  storedEvidence       Evidence[] @relation("EvidenceStoredBy")
  releasedEvidence     Evidence[] @relation("EvidenceReleasedBy")
  submittedTuning      TuningInvoice[] @relation("TuningSubmittedBy")
  completedTuning      TuningInvoice[] @relation("TuningCompletedBy")
  createdRobberies     Robbery[] @relation("RobberyCreatedBy")
  addedBlacklist       Blacklist[] @relation("BlacklistAddedBy")
  createdUprankLocks   UprankLock[] @relation("UprankLockCreatedBy")
  createdApplications  Application[] @relation("ApplicationCreatedBy")
  processedApplications Application[] @relation("ApplicationProcessedBy")
  createdCases         Case[] @relation("CaseCreatedBy")
  createdDetectiveFolders DetectiveFolder[] @relation("DetectiveFolderCreatedBy")
  uploadedCaseImages   CaseImage[] @relation("CaseImageUploadedBy")
  instructedTrainings  Training[] @relation("TrainingInstructor")
  leadInvestigations   Investigation[] @relation("InvestigationLead")
  investigationNotes   InvestigationNote[] @relation("InvestigationNoteCreatedBy")
  unitReviews          UnitReview[] @relation("UnitReviewBy")
  requestedUpranks     UprankRequest[] @relation("UprankRequestedBy")
  processedUpranks     UprankRequest[] @relation("UprankProcessedBy")
  reviewedTeamChanges  TeamChangeReport[] @relation("TeamChangeReviewedBy")
  completedAcademyProgress AcademyProgress[] @relation("AcademyProgressCompletedBy")
  createdAcademyNotes  AcademyNote[] @relation("AcademyNoteCreatedBy")
  conductedExams       AcademyExam[] @relation("AcademyExamExaminer")
  createdRetrainings   AcademyRetraining[] @relation("AcademyRetrainingCreatedBy")
  completedRetrainings AcademyRetraining[] @relation("AcademyRetrainingCompletedBy")
  paidBonuses          BonusPayment[] @relation("BonusPaymentPaidBy")
  promotedEmployees    PromotionArchive[] @relation("PromotionArchivePromotedBy")
  terminatedEmployees  TerminationArchive[] @relation("TerminationArchiveTerminatedBy")
  notifications        Notification[] @relation("NotificationUser")

  @@map("users")
}

model Role {
  id            String   @id @default(cuid())
  name          String   @unique
  displayName   String
  color         String   @default("#6B7280")
  discordRoleId String?
  level         Int      @default(0)
  permissions   Permission[]
  users         User[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  category    String
  roles       Role[]
  createdAt   DateTime @default(now())

  @@map("permissions")
}

// ==================== PERSONAL ====================

model Employee {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeNumber   String?  @unique
  rank          String   @default("Cadet")
  rankLevel     Int      @default(0) // 1-17 aus Discord Rollen
  department    String   @default("Patrol")
  status        String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED, ON_LEAVE, TERMINATED
  hireDate      DateTime @default(now())
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationen
  absences      Absence[]
  assignedTasks Task[]     @relation("TaskAssignee")
  sanctions     Sanction[]
  robberyLeader      Robbery[] @relation("RobberyLeader")
  robberyNegotiator  Robbery[] @relation("RobberyNegotiator")
  uprankLocks        UprankLock[]
  detectiveFolders   DetectiveFolder[] @relation("DetectiveFolders")
  trainingParticipations TrainingParticipant[]
  accusedInvestigations  Investigation[] @relation("InvestigationAccused")
  witnessInvestigations  InvestigationWitness[] @relation("InvestigationWitness")
  uprankRequests         UprankRequest[] @relation("UprankRequestEmployee")
  teamChangeReports      TeamChangeReport[] @relation("TeamChangeEmployee")
  academyProgress        AcademyProgress[] @relation("AcademyProgressEmployee")
  academyNotes           AcademyNote[] @relation("AcademyNoteEmployee")
  academyExams           AcademyExam[] @relation("AcademyExamEmployee")
  academyRetrainings     AcademyRetraining[] @relation("AcademyRetrainingEmployee")
  bonusPayments          BonusPayment[] @relation("BonusPaymentEmployee")
  promotionArchive       PromotionArchive[] @relation("PromotionArchiveEmployee")

  @@map("employees")
}

// ==================== ABMELDUNGEN ====================

model Absence {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type        String   // "ABSENCE" = Abmeldung, "DAY_OFF" = Dienstfrei
  reason      String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([employeeId])
  @@index([startDate, endDate])
  @@map("absences")
}

// ==================== SYSTEM ====================

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  userAgent String?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Backup {
  id        String   @id @default(cuid())
  filename  String
  size      Int
  path      String
  status    String   @default("COMPLETED")
  createdAt DateTime @default(now())

  @@map("backups")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ==================== LEADERSHIP ====================

// Aufgaben (Trello-ähnlich)
model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("OPEN") // OPEN, IN_PROGRESS, DONE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  assigneeId  String?
  assignee    Employee? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  dueDate     DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([assigneeId])
  @@index([createdById])
  @@index([status])
  @@map("tasks")
}

// Sanktionen
model Sanction {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  hasWarning  Boolean   @default(false) // Verwarnung
  hasFine     Boolean   @default(false) // Geldstrafe
  hasMeasure  Boolean   @default(false) // Maßnahme
  reason      String
  amount      Int?      // Für Geldstrafen (in Dollar)
  measure     String?   // Beschreibung der Maßnahme
  issuedById  String
  issuedBy    User      @relation(fields: [issuedById], references: [id])
  status      String    @default("ACTIVE") // ACTIVE, REVOKED, EXPIRED
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([employeeId])
  @@index([issuedById])
  @@map("sanctions")
}

// Kasse
model Treasury {
  id           String   @id @default(cuid())
  regularCash  Int      @default(0) // Normale Kasse in Dollar
  blackMoney   Int      @default(0) // Schwarzgeld in Dollar
  updatedAt    DateTime @updatedAt

  @@map("treasury")
}

model TreasuryTransaction {
  id          String   @id @default(cuid())
  type        String   // DEPOSIT, WITHDRAWAL
  moneyType   String   // REGULAR, BLACK
  amount      Int      // Betrag in Dollar
  reason      String
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([createdById])
  @@index([moneyType])
  @@map("treasury_transactions")
}

// Notizen
model Note {
  id          String   @id @default(cuid())
  title       String
  content     String
  category    String   @default("GENERAL") // GENERAL, MEETING, IMPORTANT
  isPinned    Boolean  @default(false)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
  @@index([category])
  @@map("notes")
}

// Discord Ankündigungen
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String
  channelId   String?
  messageId   String?   // Discord Message ID nach dem Senden
  status      String    @default("DRAFT") // DRAFT, SENT
  sentAt      DateTime?
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([createdById])
  @@index([status])
  @@map("announcements")
}

// ==================== ASSERVATE ====================

model Evidence {
  id          String    @id @default(cuid())
  name        String
  description String?
  category    String    @default("SONSTIGES") // WAFFEN, DROGEN, GELD, FAHRZEUGE, DOKUMENTE, SONSTIGES
  quantity    Int       @default(1)
  location    String?   // Lagerort
  caseNumber  String?   // Aktenzeichen
  status      String    @default("EINGELAGERT") // EINGELAGERT, AUSGELAGERT, VERNICHTET, FREIGEGEBEN
  storedById  String
  storedBy    User      @relation("EvidenceStoredBy", fields: [storedById], references: [id])
  releasedById String?
  releasedBy  User?     @relation("EvidenceReleasedBy", fields: [releasedById], references: [id])
  releasedAt  DateTime?
  releaseReason String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([category])
  @@index([caseNumber])
  @@map("evidence")
}

// ==================== TUNING RECHNUNGEN ====================

model TuningInvoice {
  id          String    @id @default(cuid())
  amount      Int                           // Betrag in Dollar
  imagePath   String                        // Pfad zum Beweisfoto
  status      String    @default("OFFEN")   // OFFEN, ERLEDIGT
  submittedById String
  submittedBy User      @relation("TuningSubmittedBy", fields: [submittedById], references: [id])
  completedById String?
  completedBy User?     @relation("TuningCompletedBy", fields: [completedById], references: [id])
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([submittedById])
  @@map("tuning_invoices")
}

// ==================== RÄUBE ====================

model Robbery {
  id              String    @id @default(cuid())
  leaderId        String                          // Einsatzleitung
  leader          Employee  @relation("RobberyLeader", fields: [leaderId], references: [id])
  negotiatorId    String                          // Verhandlungsführung
  negotiator      Employee  @relation("RobberyNegotiator", fields: [negotiatorId], references: [id])
  imagePath       String                          // Beweisfoto
  createdById     String
  createdBy       User      @relation("RobberyCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())

  @@index([leaderId])
  @@index([negotiatorId])
  @@index([createdAt])
  @@map("robberies")
}

// ==================== BLACKLIST ====================

model Blacklist {
  id          String    @id @default(cuid())
  discordId   String    @unique              // Discord ID des gesperrten Users
  username    String                          // Discord Username (zur Anzeige)
  reason      String                          // Grund für Blacklist
  addedById   String
  addedBy     User      @relation("BlacklistAddedBy", fields: [addedById], references: [id])
  expiresAt   DateTime?                       // Optional: Ablaufdatum (null = permanent)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([discordId])
  @@map("blacklist")
}

// ==================== UPRANK-SPERREN ====================

model UprankLock {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reason      String                          // Grund (z.B. "Teamwechsel zu Team Green")
  team        String                          // Team das die Sperre ausgelöst hat
  lockedUntil DateTime                        // Bis wann gesperrt
  isActive    Boolean   @default(true)
  createdById String
  createdBy   User      @relation("UprankLockCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())

  @@index([employeeId])
  @@index([lockedUntil])
  @@map("uprank_locks")
}

// ==================== BEWERBUNGEN ====================

model Application {
  id              String    @id @default(cuid())

  // Basisdaten
  applicantName   String                          // Name des Bewerbers (Vor- und Nachname)
  applicationDate DateTime  @default(now())       // Bewerbungsdatum
  idCardImage     String?                         // Pfad zum Personalausweis-Bild

  // Discord (optional für späteren Schritt)
  discordId       String?                         // Discord ID des Bewerbers
  discordUsername String?                         // Discord Username

  // Einstellungskriterien (Checkboxen)
  criteriaStabilization    Boolean @default(false)  // Stabilisationsschein geprüft
  criteriaVisa             Boolean @default(false)  // Visumsstufe geprüft
  criteriaNoOffenses       Boolean @default(false)  // Keine Straftaten (7 Tage)
  criteriaAppearance       Boolean @default(false)  // Angemessenes Aussehen
  criteriaNoFactionLock    Boolean @default(false)  // Keine Fraktionssperre
  criteriaNoOpenBills      Boolean @default(false)  // Keine offenen Rechnungen
  criteriaSearched         Boolean @default(false)  // Durchsuchen
  criteriaBlacklistChecked Boolean @default(false)  // Blacklist gecheckt
  criteriaHandbookGiven    Boolean @default(false)  // Diensthandbuch ausgegeben
  criteriaEmploymentTest   Boolean @default(false)  // Einstellungstest
  criteriaRpSituation      Boolean @default(false)  // RP Situation dargestellt (AVK) & Smalltalk

  // Fragenkatalog (JSON Array mit Frage-IDs die als bestanden markiert sind)
  questionsCompleted String?                       // JSON Array: ["q1", "q2", ...]

  // Onboarding Checkliste (JSON Array mit abgehakten Items)
  onboardingCompleted String?                      // JSON Array: ["clothes", "discord", ...]

  // Discord Einladung
  discordInviteLink String?                        // Generierter Einladungslink
  discordRolesAssigned Boolean @default(false)     // Rollen wurden vergeben

  // Status und Workflow
  status          String    @default("CRITERIA")  // CRITERIA, QUESTIONS, ONBOARDING, COMPLETED, REJECTED
  currentStep     Int       @default(1)           // 1=Kriterien, 2=Fragen, 3=Onboarding, 4=Abgeschlossen
  notes           String?                         // Notizen zum Bewerber
  interviewDate   DateTime?                       // Geplantes Gespräch
  interviewNotes  String?                         // Notizen vom Gespräch
  rejectionReason String?                         // Ablehnungsgrund

  // Bearbeiter
  createdById     String
  createdBy       User      @relation("ApplicationCreatedBy", fields: [createdById], references: [id])
  processedById   String?
  processedBy     User?     @relation("ApplicationProcessedBy", fields: [processedById], references: [id])
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([discordId])
  @@index([status])
  @@map("applications")
}

// ==================== DETECTIVES - ERMITTLUNGSAKTEN ====================

// Ordner pro Detektiv
model DetectiveFolder {
  id              String    @id @default(cuid())
  name            String                          // Name des Ordners (z.B. Detektivname)
  description     String?                         // Beschreibung
  detectiveId     String                          // Mitarbeiter (Detektiv)
  detective       Employee  @relation("DetectiveFolders", fields: [detectiveId], references: [id], onDelete: Cascade)
  createdById     String
  createdBy       User      @relation("DetectiveFolderCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationen
  cases           Case[]

  @@unique([detectiveId])                         // Ein Ordner pro Detektiv
  @@index([detectiveId])
  @@map("detective_folders")
}

model Case {
  id              String    @id @default(cuid())
  caseNumber      String    @unique               // Aktenzeichen z.B. "DET-2024-001"
  title           String                          // Titel der Ermittlung
  description     String?                         // Beschreibung
  status          String    @default("OPEN")      // OPEN, IN_PROGRESS, CLOSED, ARCHIVED
  priority        String    @default("NORMAL")    // LOW, NORMAL, HIGH, CRITICAL
  suspects        String?                         // Verdächtige (Text)
  notes           String?                         // Interne Notizen
  folderId        String                          // Gehört zu einem Detektiv-Ordner
  folder          DetectiveFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  createdById     String
  createdBy       User      @relation("CaseCreatedBy", fields: [createdById], references: [id])
  closedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationen
  images          CaseImage[]

  @@index([status])
  @@index([caseNumber])
  @@index([folderId])
  @@map("cases")
}

model CaseImage {
  id          String   @id @default(cuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  imagePath   String                             // Pfad zum Bild
  description String?                            // Bildbeschreibung
  uploadedById String
  uploadedBy  User     @relation("CaseImageUploadedBy", fields: [uploadedById], references: [id])
  createdAt   DateTime @default(now())

  @@index([caseId])
  @@map("case_images")
}

// ==================== POLICE ACADEMY ====================

// Schulungstypen (z.B. "Schießtraining", "Verhandlungstaktik", etc.)
model TrainingType {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  duration    Int        @default(60)           // Dauer in Minuten
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationen
  trainings   Training[]

  @@map("training_types")
}

// Geplante Schulungen
model Training {
  id            String    @id @default(cuid())
  typeId        String
  type          TrainingType @relation(fields: [typeId], references: [id])
  title         String                          // Spezifischer Titel
  description   String?                         // Zusätzliche Details
  scheduledAt   DateTime                        // Wann findet die Schulung statt
  location      String?                         // Ort (z.B. "Schießstand", "Besprechungsraum")
  maxParticipants Int?                          // Max. Teilnehmer (null = unbegrenzt)
  status        String    @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  instructorId  String
  instructor    User      @relation("TrainingInstructor", fields: [instructorId], references: [id])
  notes         String?                         // Interne Notizen
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationen
  participants  TrainingParticipant[]

  @@index([status])
  @@index([scheduledAt])
  @@index([instructorId])
  @@map("trainings")
}

// Teilnehmer an Schulungen
model TrainingParticipant {
  id          String    @id @default(cuid())
  trainingId  String
  training    Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  status      String    @default("REGISTERED")  // REGISTERED, ATTENDED, NO_SHOW, EXCUSED
  grade       String?                           // Bewertung (optional): EXCELLENT, GOOD, SATISFACTORY, FAILED
  feedback    String?                           // Feedback vom Ausbilder
  registeredAt DateTime @default(now())
  attendedAt  DateTime?

  @@unique([trainingId, employeeId])
  @@index([trainingId])
  @@index([employeeId])
  @@map("training_participants")
}

// ==================== INTERNAL AFFAIRS ====================

// Interne Ermittlungen
model Investigation {
  id              String    @id @default(cuid())
  caseNumber      String    @unique               // IA-2024-001
  title           String
  description     String?
  status          String    @default("OPEN")      // OPEN, IN_PROGRESS, CLOSED, ARCHIVED
  priority        String    @default("NORMAL")    // LOW, NORMAL, HIGH, CRITICAL
  category        String    @default("BESCHWERDE") // BESCHWERDE, DISZIPLINAR, KORRUPTION, SONSTIGES
  accusedId       String?                          // Beschuldigter Mitarbeiter
  accused         Employee?  @relation("InvestigationAccused", fields: [accusedId], references: [id], onDelete: SetNull)
  complainant     String?                          // Name des Beschwerdeführers (extern)
  findings        String?                          // Ermittlungsergebnisse
  recommendation  String?                          // Empfehlung (z.B. "Keine Maßnahme", "Verwarnung", etc.)
  leadInvestigatorId String
  leadInvestigator User      @relation("InvestigationLead", fields: [leadInvestigatorId], references: [id])
  closedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationen
  notes           InvestigationNote[]
  witnesses       InvestigationWitness[]

  @@index([status])
  @@index([caseNumber])
  @@index([accusedId])
  @@map("investigations")
}

// Notizen zu einer Ermittlung
model InvestigationNote {
  id              String    @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  content         String
  isConfidential  Boolean   @default(false)       // Nur für IA sichtbar
  createdById     String
  createdBy       User      @relation("InvestigationNoteCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())

  @@index([investigationId])
  @@map("investigation_notes")
}

// Zeugen einer Ermittlung
model InvestigationWitness {
  id              String    @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  employeeId      String?                          // Mitarbeiter als Zeuge
  employee        Employee?  @relation("InvestigationWitness", fields: [employeeId], references: [id], onDelete: SetNull)
  externalName    String?                          // Externer Zeuge (Name)
  statement       String?                          // Aussage
  interviewedAt   DateTime?
  createdAt       DateTime  @default(now())

  @@index([investigationId])
  @@map("investigation_witnesses")
}

// ==================== QUALITY ASSURANCE ====================

// Unit-Überprüfungen
model UnitReview {
  id              String    @id @default(cuid())
  unit            String                            // Team Name (z.B. "Team Green", "HR", etc.)
  reviewDate      DateTime                          // Datum der Überprüfung
  rating          Int       @default(3)             // 1-5 Sterne
  findings        String?                           // Feststellungen
  recommendations String?                           // Empfehlungen
  status          String    @default("DRAFT")       // DRAFT, SUBMITTED, REVIEWED
  reviewerId      String
  reviewer        User      @relation("UnitReviewBy", fields: [reviewerId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([unit])
  @@index([status])
  @@map("unit_reviews")
}

// ==================== INTERNAL AFFAIRS - TEAMWECHSEL BERICHTE ====================

// Automatische Berichte bei Teamwechseln für IA
model TeamChangeReport {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation("TeamChangeEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  previousTeam    String                            // Vorheriges Team
  newTeam         String                            // Neues Team
  changeDate      DateTime  @default(now())         // Datum des Wechsels
  uprankLockId    String?                           // Referenz zur Uprank-Sperre (falls vorhanden)
  notes           String?                           // Notizen zum Wechsel
  status          String    @default("PENDING")     // PENDING, REVIEWED, ARCHIVED
  reviewedById    String?
  reviewedBy      User?     @relation("TeamChangeReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  reviewNotes     String?                           // IA-Bewertung
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([changeDate])
  @@map("team_change_reports")
}

// ==================== TEAMLEITUNG - UPRANK ANTRÄGE ====================

// Uprank-Anträge von Teamleitern an das Management
model UprankRequest {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation("UprankRequestEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  currentRank     String                            // Aktueller Rang
  targetRank      String                            // Gewünschter Rang
  reason          String                            // Begründung
  achievements    String?                           // Leistungen/Erfolge
  status          String    @default("PENDING")     // PENDING, APPROVED, REJECTED
  rejectionReason String?                           // Ablehnungsgrund
  requestedById   String
  requestedBy     User      @relation("UprankRequestedBy", fields: [requestedById], references: [id])
  processedById   String?
  processedBy     User?     @relation("UprankProcessedBy", fields: [processedById], references: [id])
  processedAt     DateTime?
  isAcademyRequest Boolean  @default(false)         // Ob aus Academy-System
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([employeeId])
  @@index([status])
  @@map("uprank_requests")
}

// ==================== ACADEMY - AUSBILDUNGSMODULE ====================

// Ausbildungsmodule (definierbar im Admin-Bereich)
model AcademyModule {
  id          String    @id @default(cuid())
  name        String                              // Name des Moduls (z.B. "Aktenschulung")
  description String?                             // Beschreibung
  category    String                              // "JUNIOR_OFFICER" oder "OFFICER"
  sortOrder   Int       @default(0)               // Reihenfolge in der Anzeige
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationen
  progress    AcademyProgress[]

  @@index([category])
  @@index([isActive])
  @@map("academy_modules")
}

// Fortschritt eines Azubis bei einem Modul
model AcademyProgress {
  id          String    @id @default(cuid())
  moduleId    String
  module      AcademyModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    Employee  @relation("AcademyProgressEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)
  completedAt DateTime?
  completedById String?                           // Wer hat abgehakt
  completedBy User?     @relation("AcademyProgressCompletedBy", fields: [completedById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([moduleId, employeeId])
  @@index([employeeId])
  @@index([moduleId])
  @@map("academy_progress")
}

// Interne Notizen zu einem Azubi (mit Permission-System)
model AcademyNote {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation("AcademyNoteEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  content     String
  createdById String
  createdBy   User      @relation("AcademyNoteCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([employeeId])
  @@map("academy_notes")
}

// Prüfungsprotokolle (Wiedereinstellungstest, etc.)
model AcademyExam {
  id                  String    @id @default(cuid())
  employeeId          String
  employee            Employee  @relation("AcademyExamEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  examType            String    @default("WIEDEREINSTELLUNG") // WIEDEREINSTELLUNG, BEFOERDERUNG, etc.
  theoryScore         Int       @default(0)                   // Theoriefragen (max. 13)
  theoryMax           Int       @default(13)
  funcCodesScore      Int       @default(0)                   // Funkcodes (max. 10)
  funcCodesMax        Int       @default(10)
  lawScore            Int       @default(0)                   // Gesetzesfragen (max. 10)
  lawMax              Int       @default(10)
  reportScore         Int       @default(0)                   // Einsatzbericht (max. 25)
  reportMax           Int       @default(25)
  situationsPassed    Boolean   @default(false)               // Situationsfragen bestanden
  totalScore          Int       @default(0)                   // Gesamtpunktzahl
  maxScore            Int       @default(58)                  // Maximalpunktzahl
  grade               Int?                                    // Note 1-6
  passed              Boolean   @default(false)               // Bestanden?
  examinerNotes       String?                                 // Anmerkungen des Prüfers
  examinerId          String
  examiner            User      @relation("AcademyExamExaminer", fields: [examinerId], references: [id])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([employeeId])
  @@index([examType])
  @@index([passed])
  @@map("academy_exams")
}

// Nachschulungen
model AcademyRetraining {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation("AcademyRetrainingEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  type            String                                      // Art der Nachschulung (z.B. "Funkschulung", "Gesetze", etc.)
  reason          String                                      // Grund für die Nachschulung
  status          String    @default("PENDING")               // PENDING, COMPLETED, CANCELLED
  completedAt     DateTime?
  completedById   String?
  completedBy     User?     @relation("AcademyRetrainingCompletedBy", fields: [completedById], references: [id])
  createdById     String
  createdBy       User      @relation("AcademyRetrainingCreatedBy", fields: [createdById], references: [id])
  notes           String?                                     // Zusätzliche Notizen
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([employeeId])
  @@index([status])
  @@map("academy_retrainings")
}

// ==================== ACADEMY - FRAGENKATALOG & EINSTELLUNGSKRITERIEN ====================

// Fragenkatalog für Bewerbungen
model AcademyQuestion {
  id          String    @id @default(cuid())
  question    String                              // Die Frage
  sortOrder   Int       @default(0)               // Reihenfolge
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([sortOrder])
  @@map("academy_questions")
}

// Einstellungskriterien für Bewerbungen
model AcademyCriterion {
  id          String    @id @default(cuid())
  name        String                              // Name des Kriteriums
  sortOrder   Int       @default(0)               // Reihenfolge
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([sortOrder])
  @@map("academy_criteria")
}

// ==================== SONDERZAHLUNGEN / BONUS SYSTEM ====================

// Konfiguration der Bonus-Arten (im Admin-Bereich einstellbar)
model BonusConfig {
  id              String    @id @default(cuid())
  activityType    String    @unique                           // Eindeutige Kennung (z.B. "APPLICATION_COMPLETED", "TRAINING_CONDUCTED")
  displayName     String                                      // Anzeigename (z.B. "Bewerbung abgeschlossen")
  description     String?                                     // Beschreibung der Tätigkeit
  amount          Int       @default(0)                       // Betrag in Dollar
  isActive        Boolean   @default(true)                    // Ob diese Bonusart aktiv ist
  category        String    @default("GENERAL")               // Kategorie (HR, ACADEMY, IA, DETECTIVE, GENERAL)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationen
  payments        BonusPayment[]

  @@index([activityType])
  @@index([isActive])
  @@map("bonus_configs")
}

// Einzelne Bonus-Zahlungen (werden automatisch erstellt bei Tätigkeiten)
model BonusPayment {
  id              String    @id @default(cuid())
  configId        String
  config          BonusConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  employeeId      String
  employee        Employee  @relation("BonusPaymentEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  amount          Int                                         // Betrag zum Zeitpunkt der Erstellung
  reason          String?                                     // Details zur Tätigkeit (z.B. Name des Azubis)
  referenceId     String?                                     // ID der verknüpften Entität (z.B. Application ID)
  referenceType   String?                                     // Typ der Referenz (z.B. "Application", "Training")
  weekStart       DateTime                                    // Start der Woche (Montag 00:00)
  weekEnd         DateTime                                    // Ende der Woche (Sonntag 23:59)
  status          String    @default("PENDING")               // PENDING, PAID, CANCELLED
  paidAt          DateTime?
  paidById        String?
  paidBy          User?     @relation("BonusPaymentPaidBy", fields: [paidById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([employeeId])
  @@index([configId])
  @@index([weekStart, weekEnd])
  @@index([status])
  @@map("bonus_payments")
}

// Wöchentliche Abrechnungsperioden
model BonusWeek {
  id              String    @id @default(cuid())
  weekStart       DateTime                                    // Start der Woche (Montag 00:00)
  weekEnd         DateTime                                    // Ende der Woche (Sonntag 23:59)
  status          String    @default("OPEN")                  // OPEN, CLOSED, PAID
  totalAmount     Int       @default(0)                       // Gesamtbetrag
  closedAt        DateTime?                                   // Wann wurde die Woche geschlossen
  submittedToManagement Boolean @default(false)               // An Management weitergeleitet
  submittedAt     DateTime?
  notes           String?                                     // Notizen vom Management
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([weekStart, weekEnd])
  @@index([status])
  @@map("bonus_weeks")
}

// ==================== BENACHRICHTIGUNGEN ====================

model Notification {
  id          String    @id @default(cuid())
  userId      String                              // Empfänger der Benachrichtigung
  user        User      @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)
  type        String                              // PROMOTION, DEMOTION, SANCTION, BONUS, TUNING, UNIT_CHANGE, UNIT_PROMOTION
  title       String                              // Titel der Benachrichtigung
  message     String                              // Nachrichtentext
  data        String?                             // JSON-Daten für zusätzliche Informationen
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ==================== ARCHIV SYSTEM ====================

// Beförderungsarchiv
model PromotionArchive {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation("PromotionArchiveEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  oldRank         String                                      // Alter Rang (Name)
  oldRankLevel    Int                                         // Alter Rang-Level
  newRank         String                                      // Neuer Rang (Name)
  newRankLevel    Int                                         // Neuer Rang-Level
  promotedById    String
  promotedBy      User      @relation("PromotionArchivePromotedBy", fields: [promotedById], references: [id])
  reason          String?                                     // Grund für die Beförderung
  promotedAt      DateTime  @default(now())                   // Zeitpunkt der Beförderung
  createdAt       DateTime  @default(now())

  @@index([employeeId])
  @@index([promotedAt])
  @@map("promotion_archive")
}

// Kündigungsarchiv
model TerminationArchive {
  id              String    @id @default(cuid())
  discordId       String                                      // Discord ID des Mitarbeiters
  discordUsername String                                      // Discord Username
  displayName     String?                                     // Anzeigename
  badgeNumber     String?                                     // Dienstnummer
  rankName        String                                      // Rang zum Zeitpunkt der Kündigung
  hireDate        DateTime?                                   // Einstellungsdatum
  terminationType String    @default("RESIGNATION")           // RESIGNATION (Kündigung), TERMINATION (Entlassung), INACTIVE (Inaktivität)
  reason          String?                                     // Kündigungsgrund
  terminatedById  String?
  terminatedBy    User?     @relation("TerminationArchiveTerminatedBy", fields: [terminatedById], references: [id])
  terminatedAt    DateTime  @default(now())                   // Zeitpunkt der Kündigung
  createdAt       DateTime  @default(now())

  @@index([discordId])
  @@index([terminatedAt])
  @@index([terminationType])
  @@map("termination_archive")
}

// ==================== SYSTEM EINSTELLUNGEN ====================

// Discord Announcement Kanäle
model DiscordAnnouncementChannel {
  id          String    @id @default(cuid())
  type        String    @unique                              // PROMOTION, DEMOTION, SANCTION, UNIT_CHANGE, UNIT_PROMOTION, ACADEMY_GRADUATION, TERMINATION, HIRE
  channelId   String                                         // Discord Channel ID
  enabled     Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("discord_announcement_channels")
}
